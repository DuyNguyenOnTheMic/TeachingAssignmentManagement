var select=$(".select2"),dropzone=$("#dpz-single-file"),isUpdate=$("#isUpdate"),isCheckStudentNumber=$("#isCheckStudentNumber"),rootUrl=$("#loader").data("request-url");function startProgressBar(){$.connection.progressHub.client.addProgress=function(t,e){e>=100||$("#myProgress").attr({"aria-valuenow":e}).text(t+" "+e+" %").width(e)},$.connection.hub.start()}function importSucceeded(t){if(isUpdate.val(!1),t.length){var e,n=$("#errorLecturers-section");n.show(),populateDatatable(t),t[0].Item6?(e="Đã import dữ liệu! \nCó một số giảng viên có lịch giảng dạy bị trùng, vui lòng xem chi tiết ở cuối trang.",setVisibleColumn(!0),setTimeout((function(){n.find(".alert").hide(),n.find(".importUser").hide()}),100)):(e="Đã import dữ liệu! \nCó một số giảng viên chưa có trong hệ thống, vui lòng xem chi tiết ở cuối trang.",setVisibleColumn(!1),setTimeout((function(){n.find(".alert").show(),n.find(".importUser").show()}),100)),Swal.fire({title:"Thông báo",text:e,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}else Swal.fire({title:"Thông báo",text:"Import thời khoá biểu thành công!",icon:"success",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}),$("#errorLecturers-section").hide();window.onbeforeunload=null}function setVisibleColumn(t){for(var e=$("#tblErrorLecturers").DataTable(),n=3;n<=6;n++)e.column(n).visible(t,t);e.columns.adjust().draw(t)}function importAgain(t,e){$.each(t.files,(function(t,e){return e.status=Dropzone.QUEUED,e.previewElement.classList.remove("dz-error"),e.previewElement.classList.add("dz-success")})),isUpdate.val(e),t.processQueue()}function deleteAndImport(t){Swal.fire({title:"Đang xoá dữ liệu...",allowEscapeKey:!1,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});var e=$("#term").val(),n=$("#major").val();$.ajax({type:"POST",url:rootUrl+"Timetable/DeleteAll",data:{term:e,major:n},success:function(e){e.success&&(Swal.close(),importAgain(t,!1))}})}function populateDatatable(t){var e,n=$("#lblErrorLecturers").text();$.fn.DataTable.isDataTable("#tblErrorLecturers")||(e=$("#tblErrorLecturers").DataTable({columns:[{data:"",defaultContent:""},{data:"Item1"},{data:"Item2"},{data:"Item3",defaultContent:""},{data:"Item4",defaultContent:""},{data:"Item5",defaultContent:""},{data:"Item6",defaultContent:""}],columnDefs:[{searchable:!1,orderable:!1,className:"text-center",width:"5%",targets:0}],order:[[1,"asc"]],dom:'<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l><"col-sm-12 col-lg-8 ps-xl-75 px-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1"f>B>>>t<"d-flex justify-content-between mx-2 row mb-1"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',displayLength:10,lengthMenu:[[10,25,50,-1],[10,25,50,"tất cả"]],buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle me-2",text:feather.icons.share.toSvg({class:"font-small-4 me-50"})+"Export",buttons:[{extend:"print",className:"dropdown-item",title:n},{extend:"excel",className:"dropdown-item",title:n},{extend:"pdf",className:"dropdown-item",title:n},{extend:"copy",className:"dropdown-item",title:n}],init:function(t,e,n){$(e).removeClass("btn-secondary"),$(e).parent().removeClass("btn-group"),setTimeout((function(){$(e).closest(".dt-buttons").removeClass("btn-group").addClass("d-inline-flex mt-50")}),50)}},{text:feather.icons.plus.toSvg({class:"me-50 font-small-4"})+"Import vào hệ thống",className:"importUser btn btn-primary",attr:{onclick:"importUsers()"}}],language:{url:rootUrl+"app-assets/language/datatables/vi.json"}})),(e=$("#tblErrorLecturers").DataTable()).clear().rows.add(t).draw(),e.on("draw.dt",(function(){e.column(0,{search:"applied",order:"applied"}).nodes().each((function(t,n){t.innerHTML=n+1,e.cell(t).invalidate("dom")}))}))}function importUsers(){Swal.fire({title:"Đang import giảng viên...",allowEscapeKey:!1,allowOutsideClick:!1,html:'<div class="progress progress-bar-primary my-2" style="height: 30px"><div id="myProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>',didOpen:()=>{Swal.showLoading()}}),startProgressBar(),window.onbeforeunload=function(){return"Bạn có chắc muốn thoát, tiến trình import có thể sẽ không được lưu?"};var t=$("#tblErrorLecturers").DataTable().rows().data().toArray(),e=$(t).map((function(){return this.Item1})).get(),n=$(t).map((function(){return this.Item2})).get();$.ajax({type:"POST",url:rootUrl+"User/Import",data:{lecturerId:e,lecturerName:n},success:function(t){window.onbeforeunload=null,t.success?($("#errorLecturers-section").hide(),Swal.fire({title:"Thông báo",text:"Import giảng viên thành công, bạn có muốn import lại file không?",icon:"question",showCancelButton:!0,confirmButtonText:"Import lại",cancelButtonText:"Huỷ",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1}).then((t=>{t.isConfirmed&&deleteAndImport(Dropzone.forElement("#dpz-single-file"))}))):Swal.fire({title:"Thông báo",html:t.message,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}})}select.each((function(){var t=$(this);t.wrap('<div class="position-relative"></div>'),t.select2({language:"vi",dropdownAutoWidth:!0,dropdownParent:t.parent(),placeholder:t[0][0].innerHTML})})),dropzone.dropzone({url:rootUrl+"Timetable/Import",autoProcessQueue:!1,paramName:"postedFile",timeout:null,maxFiles:1,maxFilesize:50,acceptedFiles:".xlsx, .xls",dictFileTooBig:"Tệp quá lớn ({{filesize}}MB). Kích thước tối đa: {{maxFilesize}}MB.",dictInvalidFileType:"Tệp tin sai định dạng, chỉ được upload file excel",success:function(t,e){importSucceeded(e)},init:function(){var t=this;this.on("addedfile",(function(t){dropzone.find(".dz-progress").addClass("d-none")})),this.on("maxfilesexceeded",(function(e){t.removeAllFiles(),t.addFile(e)})),$("#submit-all").click((function(e){e.preventDefault(),e.stopPropagation();var n=t.getQueuedFiles().length,r=$("#term").val(),o=$("#major").val();""==r&&""==o?toastr.warning("Bạn chưa chọn học kỳ và ngành"):""==r?toastr.warning("Bạn chưa chọn học kỳ"):""==o?toastr.warning("Bạn chưa chọn ngành"):0==n?toastr.warning("File chưa được upload hoặc sai định dạng "):(dropzone.find(".dz-progress").removeClass("d-none"),t.processQueue())})),this.on("sending",(function(t,e,n){$(".form-data").each((function(){n.append($(this).attr("name"),$(this).val())})),Swal.fire({title:"Vui lòng đợi...",allowEscapeKey:!1,allowOutsideClick:!1,html:'<div class="progress progress-bar-primary my-2" style="height: 30px"><div id="myProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>',didOpen:()=>{Swal.showLoading()}}),startProgressBar(),window.onbeforeunload=function(){return"Bạn có chắc muốn thoát, tiến trình import có thể sẽ không được lưu?"}})),this.on("error",(function(e,n,r){if(Swal.close(),isCheckStudentNumber.val(!0),$("#errorLecturers-section").hide(),window.onbeforeunload=null,r){var o=document.querySelectorAll("[data-dz-errormessage]");o[o.length-1].innerHTML="Đã xảy ra lỗi! Vui lòng kiểm tra và chọn lại tệp tin.",417==r.status?(isUpdate.val(!1),Swal.fire({title:"Thông báo",html:n,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})):409==r.status?(isUpdate.val(!1),Swal.fire({title:"Thông báo",text:n,icon:"question",showDenyButton:!0,showCancelButton:!0,confirmButtonText:"Cập nhật",denyButtonText:"Thay thế",cancelButtonText:"Huỷ",customClass:{confirmButton:"btn btn-primary",denyButton:"btn btn-success ms-1",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1}).then((e=>{e.isConfirmed?importAgain(t,!0):e.isDenied&&deleteAndImport(t)}))):400==r.status&&Swal.fire({title:"Thông báo",text:n,icon:"warning",showCancelButton:!0,cancelButtonText:"Huỷ",confirmButtonText:"Import tiếp",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1}).then((e=>{e.isConfirmed&&(isCheckStudentNumber.val(!1),importAgain(t,isUpdate.val()))}))}}))}});