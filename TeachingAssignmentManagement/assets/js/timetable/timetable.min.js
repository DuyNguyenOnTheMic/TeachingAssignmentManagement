var termId=$("#term").val(),majorId=$("#major").val(),rootUrl=$("#loader").data("request-url"),curriculumFilter=$("#curriculumFilter"),lecturerFilter=$("#lecturerFilter");$((function(){updateCount(),$(document).on("select2:open",(()=>{document.querySelector(".select2-container--open .select2-search__field").focus()}))}));var rowCount=$("#tblAssign tbody tr").length;if(0==rowCount)$("#assignLecturerDiv").empty().append('<h4 class="text-center mt-2">Học kỳ này chưa có dữ liệu <i class="feather feather-help-circle"></i></h4><div class="card-body"><img class="mx-auto p-3 d-block w-50" alt="Welcome" src="'+rootUrl+'assets/images/img_no_data.svg"></div>');else{$('#tblAssign [data-bs-toggle="tooltip"]').tooltip({trigger:"hover"});var popoverTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')),popoverList=popoverTriggerList.map((function(t){return new bootstrap.Popover(t,{html:!0,sanitize:!1})}))}function FilterCount(t){t.parent().find(".select2-search__field").attr("placeholder","Đã chọn "+curriculumFilter.val().length)}function showAllClass(){hidePopover(),$("#tblAssign tbody tr").show(),$(".assign-card").show()}function hidePopover(){$('#tblAssign [data-bs-toggle="popover"]').popover("hide")}function splitString(t){return t.substring(0,t.lastIndexOf(" ")).split(" ").map((function(t){return t[0]})).join(".")+" "+t.split(" ").pop()}function assignLecturer(t,e,r){$.ajax({type:"POST",url:rootUrl+"Timetable/Assign",data:{id:t,lecturerId:e,warning:r},success:function(t){t.success?(toastr.options.positionClass="toast-bottom-right",toastr.success("Thành công!")):Swal.fire({title:"Thông báo",html:t.message,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}})}-1==majorId&&$("#tblAssign tbody tr").each((function(){var t=$(this),e=t.attr("id"),r=$(".abb-"+e).first().data("abb");t.find("td:first").append(" ("+r+")"),curriculumFilter.find('option[value="'+e+'"]').append(" ("+r+")")})),$.fn.select2.amd.define("select2/selectAllAdapter",["select2/utils","select2/dropdown","select2/dropdown/attachBody"],(function(t,e,r){function n(){}return n.prototype.render=function(t){var e=this,r=t.call(this),n=$('<button class="btn btn-sm text-start" type="button"><i class="feather feather-check-square"></i> Chọn tất cả</button>'),s=$('<button class="btn btn-sm text-start" type="button"><i class="feather feather-square"></i> Bỏ chọn tất cả</button>'),i=$('<div class="d-grid"></div>').append(n).append(s);return this.$element.prop("multiple")?(r.find(".select2-dropdown").prepend(i),n.on("click",(function(){hidePopover(),curriculumFilter.find("option").prop("selected","selected").trigger("change"),e.trigger("close"),$("#tblAssign").find("tbody tr").show(),FilterCount(curriculumFilter)})),s.on("click",(function(){hidePopover(),curriculumFilter.val(null).trigger("change"),e.trigger("close"),$("#tblAssign").find("tbody tr").hide(),curriculumFilter.parent().find(".select2-search__field").attr("placeholder","Lọc môn học")})),r):r},t.Decorate(t.Decorate(e,r),n)})),curriculumFilter.find("option").prop("selected","selected"),curriculumFilter.wrap('<div class="position-relative my-50 me-1"></div>'),curriculumFilter.select2({language:"vi",dropdownAutoWidth:!0,dropdownParent:curriculumFilter.parent(),placeholder:"Lọc môn học",dropdownAdapter:$.fn.select2.amd.require("select2/selectAllAdapter")}),curriculumFilter.parent().find(".select2-search__field").attr("placeholder","Lọc môn học"),curriculumFilter.on("select2:select",(function(t){$("#"+t.params.data.id).show(),FilterCount(curriculumFilter)})).on("select2:unselect",(function(t){$("#"+t.params.data.id).hide(),FilterCount(curriculumFilter)})),lecturerFilter.wrap('<div class="position-relative my-50"></div>'),lecturerFilter.select2({language:"vi",dropdownAutoWidth:!0,dropdownParent:lecturerFilter.parent(),placeholder:"Lọc giảng viên",allowClear:!0}).on("select2:select",(function(){showAllClass();var t=$(this),e=$("#tblAssign tbody tr"),r=t.val(),n=e.find("[data-lecturerid="+r+"]"),s=e.find(".assign-card"),i=n.closest("tr");s.not(n).hide(),e.not(i).hide()})).on("select2:unselect",(function(){showAllClass()})),$(".assign-card").each((function(){var t=$(this),e=t.data("lecturerid"),r=t.text();""!=e?t.text(splitString(r)):t.hasClass("btn-success")?t.removeClass("btn-success").addClass("btn-secondary unassigned-theory"):t.removeClass("btn-warning").addClass("btn-secondary unassigned-practical")})),$(document).off("click",".btn-assign").on("click",".btn-assign",(function(){$this=$(this);var t=$this.data("id"),e=$this.parent().find(".select2 :selected").val();warning=!0,$.ajax({type:"GET",url:rootUrl+"Timetable/CheckState",data:{id:t,termId:termId,lecturerId:e,warning:warning},success:function(r){if(r.success)assignLecturer(t,e,warning);else if(r.warning){let n=r.message+'<div class="table-responsive mt-2"><table class="table table-sm"><thead class="text-nowrap"><tr><th></th><th>Mã LHP</th><th>Tên HP</th><th>Thứ</th><th>Tiết</th><th>Phòng</th><th>Ngành</th></tr></thead><tbody>';r.classList.forEach((function(t,e){n+='<tr class="font-small-3"><td>'+(e+1)+"</td><td>"+t.classId+"</td><td>"+t.curriculumName+'</td><td class="text-nowrap">'+t.classDay+'</td><td class="text-nowrap">'+t.lessonTime+"</td><td>"+t.roomId+"</td><td>"+t.majorName+"</td></tr>"})),n+="</tbody></table></div>",Swal.fire({title:"Thông báo",width:800,html:n,icon:"warning",showCancelButton:!0,cancelButtonText:"Huỷ",confirmButtonText:"Phân công",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1}).then((r=>{r.isConfirmed&&(warning=!1,assignLecturer(t,e,warning))}))}else{let t=r.message+'<div class="table-responsive mt-2"><table class="table table-sm"><thead class="text-nowrap"><tr><th></th><th>Mã LHP</th><th>Tên HP</th><th>Thứ</th><th>Tiết</th><th>Ngành</th></tr></thead><tbody>';r.classList.forEach((function(e,r){t+='<tr class="font-small-3"><td>'+(r+1)+"</td><td>"+e.classId+"</td><td>"+e.curriculumName+'</td><td class="text-nowrap">'+e.classDay+'</td><td class="text-nowrap">'+e.lessonTime+"</td><td>"+e.majorName+"</td></tr>"})),t+="</tbody></table></div>",Swal.fire({title:"Thông báo",width:800,html:t,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}}})})),$(document).off("click",".btn-delete").on("click",".btn-delete",(function(){$this=$(this);var t=$this.data("id"),e=$this.parents().find(".popover-header").find(".class-id").text();Swal.fire({title:"Thông báo",html:'<p class="text-danger mb-0">Hãy nhập lại mã lớp học phần, '+e+" để xác nhận xoá.</p>",icon:"warning",input:"text",inputAttributes:{autocapitalize:"off"},showCancelButton:!0,cancelButtonText:"Huỷ",confirmButtonText:"Xoá",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1,preConfirm:r=>{if(r!==e)return Swal.showValidationMessage("Xác nhận xoá thất bại!"),!1;$.ajax({type:"POST",url:rootUrl+"Timetable/Delete",data:{id:t},success:function(t){t.success&&(toastr.options.positionClass="toast-bottom-right",toastr.success("Xoá lớp thành công!"))}})}})})),$(".assign-card").on("click",(function(){$('[data-bs-toggle="popover"]').not(this).popover("hide")})).on("show.bs.popover",(function(){setTimeout((()=>{var t=$(".popover-body .form-select");$(t).hasClass("select2-hidden-accessible")||populateSelect(t);var e=$(this).attr("data-lecturerid");t.val(e).trigger("change")}),0)})),$("#tblAssign").on("click",(function(){hidePopover()})),$(".btn-export").on("click",(function(){var t=rootUrl+"TimeTable/Export?termId="+termId+"&majorId="+majorId;window.open(t,"_blank").focus()}));