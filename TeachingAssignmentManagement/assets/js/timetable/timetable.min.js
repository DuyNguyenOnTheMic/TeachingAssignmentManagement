var termId=$("#term").val(),majorId=$("#major").val(),rootUrl=$("#loader").data("request-url"),termStatus=$("#termData").data("status"),subjectFilter=$("#subjectFilter"),lecturerFilter=$("#lecturerFilter"),rowCount=$("#tblAssign tbody tr").length;if($((function(){updateClassCount(),updateTotalCount(),$("#subjectCount").text(rowCount),$(document).on("select2:open",(()=>{document.querySelector(".select2-container--open .select2-search__field").focus()}))})),0==rowCount)showNoData(assignLecturerDiv,'<i class="feather feather-help-circle"></i>');else{$('#tblAssign [data-bs-toggle="tooltip"]').tooltip({trigger:"hover"});var popoverTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')),popoverList=popoverTriggerList.map((function(t){return new bootstrap.Popover(t,{html:!0,sanitize:!1})}))}function updateRow(t){t.each((function(){var t=$(this);0==t.find(".assign-card:visible").length?t.closest("tr").hide():t.closest("tr").show()}))}function filterCount(t){var e;"subjectFilter"==t.attr("id")?e="môn":"lecturerFilter"==t.attr("id")&&(e="GV"),t.parent().find(".select2-search__field").attr("placeholder","Đã chọn "+t.val().length+" "+e)}function hidePopover(){$('#tblAssign [data-bs-toggle="popover"]').popover("hide")}function splitString(t){return t.substring(0,t.lastIndexOf(" ")).split(" ").map((function(t){return t[0]})).join(".")+" "+t.split(" ").pop()}function assignLecturer(t,e,n){$.ajax({type:"POST",url:rootUrl+"Timetable/Assign",data:{id:t,lecturerId:e,warning:n},success:function(t){t.success?toastr.success("Thành công!"):Swal.fire({title:"Thông báo",html:t.message,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}})}-1==majorId&&$("#tblAssign tbody tr").each((function(){var t=$(this),e=t.attr("id"),n=t.data("abb");t.find("td:first").append(" ("+n+")"),subjectFilter.find('option[value="'+e+'"]').append(" ("+n+")")})),$.fn.select2.amd.define("select2/selectAllAdapter",["select2/utils","select2/dropdown","select2/dropdown/attachBody"],(function(t,e,n){function r(){}return r.prototype.render=function(t){var e=this,n=t.call(this),r=$('<button class="btn btn-sm text-start filter-button" type="button"><i class="feather feather-check-square"></i> Chọn tất cả</button>'),s=$('<button class="btn btn-sm text-start filter-button" type="button"><i class="feather feather-square"></i> Bỏ chọn tất cả</button>'),a=$('<div class="d-grid"></div>').append(r).append(s);return this.$element.prop("multiple")?(n.find(".select2-dropdown").prepend(a),r.on("click",(function(){hidePopover(),subjectFilter.find("option").prop("selected","selected").trigger("change"),filterCount(subjectFilter),"lecturerFilter"==e.$element.attr("id")&&(lecturerFilter.find("option").prop("selected","selected").trigger("change"),filterCount(lecturerFilter),$(".assign-card").show()),e.trigger("close"),$("#tblAssign tbody tr").show(),updateClassCount()})),s.on("click",(function(){hidePopover(),"subjectFilter"==e.$element.attr("id")?(subjectFilter.val(null).trigger("change"),subjectFilter.parent().find(".select2-search__field").attr("placeholder","Lọc môn học")):"lecturerFilter"==e.$element.attr("id")&&(lecturerFilter.val("-1").trigger("change"),lecturerFilter.parent().find(".select2-search__field").attr("placeholder","Lọc giảng viên")),e.trigger("close"),$("#tblAssign tbody tr").hide(),updateClassCount()})),n):n},t.Decorate(t.Decorate(e,n),r)})),subjectFilter.find("option").prop("selected","selected"),subjectFilter.wrap('<div class="position-relative my-50 me-1"></div>'),subjectFilter.select2({language:"vi",dropdownAutoWidth:!0,dropdownParent:subjectFilter.parent(),placeholder:"Lọc môn học",dropdownAdapter:$.fn.select2.amd.require("select2/selectAllAdapter")}),subjectFilter.parent().find(".select2-search__field").attr("placeholder","Lọc môn học"),subjectFilter.on("select2:select",(function(t){$("#"+t.params.data.id).show(),filterCount(subjectFilter),updateClassCount()})).on("select2:unselect",(function(t){$("#"+t.params.data.id).hide(),filterCount(subjectFilter),updateClassCount()})),lecturerFilter.find("option").prop("selected","selected"),lecturerFilter.wrap('<div class="position-relative my-50"></div>'),lecturerFilter.select2({language:"vi",dropdownAutoWidth:!0,dropdownParent:lecturerFilter.parent(),dropdownAdapter:$.fn.select2.amd.require("select2/selectAllAdapter")}),lecturerFilter.parent().find(".select2-search__field").attr("placeholder","Lọc giảng viên"),lecturerFilter.on("select2:select",(function(t){var e=$("#tblAssign tbody tr"),n=t.params.data.id,r=e.find('[data-lecturerid="'+n+'"]');hidePopover(),r.show(),filterCount(lecturerFilter),r.length?$("#tblAssign tbody tr:visible").length>0?(e.show(),updateRow(e)):(e.show(),$("#tblAssign .assign-card").not(r).hide(),e.not(r.closest("tr")).hide(),updateRow(e)):toastr.info("Giảng viên chưa được phân giảng lớp nào!"),updateClassCount()})).on("select2:unselect",(function(t){var e=$("#tblAssign tbody tr"),n=t.params.data.id,r=e.find('[data-lecturerid="'+n+'"]');hidePopover(),filterCount(lecturerFilter),r.length&&(r.hide(),updateRow(e)),updateClassCount()})),$(".assign-card").each((function(){var t=$(this),e=t.data("lecturerid"),n=t.text();""!=e?t.text(splitString(n)):t.hasClass("btn-success")?t.removeClass("btn-success").addClass("btn-secondary unassigned-theory"):t.removeClass("btn-warning").addClass("btn-secondary unassigned-practical")})),$(document).off("click",".btn-assign").on("click",".btn-assign",(function(){$this=$(this);var t=$this.data("id"),e=$this.parent().find(".select2 :selected").val();warning=!0,$.ajax({type:"GET",url:rootUrl+"Timetable/CheckState",data:{id:t,termId:termId,lecturerId:e,warning:warning},success:function(n){if(n.success)assignLecturer(t,e,warning);else if(n.warning){let r=n.message+' Bạn có chắc muốn phân công?<div class="table-responsive mt-2"><table class="table table-sm"><thead class="text-nowrap"><tr><th></th><th>Mã LHP</th><th>Tên HP</th><th>Thứ</th><th>Tiết</th><th>Phòng</th><th>Ngành</th></tr></thead><tbody>';n.classList.forEach((function(t,e){r+='<tr class="font-small-3"><td>'+(e+1)+"</td><td>"+t.classId+"</td><td>"+t.subjectName+'</td><td class="text-nowrap">'+t.classDay+'</td><td class="text-nowrap">'+t.lessonTime+"</td><td>"+t.roomId+"</td><td>"+t.majorName+"</td></tr>"})),r+="</tbody></table></div>",Swal.fire({title:"Thông báo",width:800,html:r,icon:"warning",showCancelButton:!0,cancelButtonText:"Huỷ",confirmButtonText:"Phân công",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1}).then((n=>{n.isConfirmed&&(warning=!1,assignLecturer(t,e,warning))}))}else{let t=n.message+'<div class="table-responsive mt-2"><table class="table table-sm"><thead class="text-nowrap"><tr><th></th><th>Mã LHP</th><th>Tên HP</th><th>Thứ</th><th>Tiết</th><th>Ngành</th></tr></thead><tbody>';n.classList.forEach((function(e,n){t+='<tr class="font-small-3"><td>'+(n+1)+"</td><td>"+e.classId+"</td><td>"+e.subjectName+'</td><td class="text-nowrap">'+e.classDay+'</td><td class="text-nowrap">'+e.lessonTime+"</td><td>"+e.majorName+"</td></tr>"})),t+="</tbody></table></div>",Swal.fire({title:"Thông báo",width:800,html:t,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}}})})),$(document).off("click",".btn-delete").on("click",".btn-delete",(function(){$this=$(this);var t=$this.data("id"),e=$this.parents().find(".popover-header").find(".class-id").text();Swal.fire({title:"Thông báo",html:'<p class="text-danger mb-0">Hãy nhập lại mã lớp học phần, '+e+" để xác nhận xoá.</p>",icon:"warning",input:"text",inputAttributes:{autocapitalize:"off"},showCancelButton:!0,cancelButtonText:"Huỷ",confirmButtonText:"Xoá",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1,preConfirm:n=>{if(n!==e)return Swal.showValidationMessage("Xác nhận xoá thất bại!"),!1;$.ajax({type:"POST",url:rootUrl+"Timetable/Delete",data:{id:t},success:function(t){t.success&&toastr.success("Xoá lớp thành công!")}})}})})),$(".assign-card").on("click",(function(){$('[data-bs-toggle="popover"]').not(this).popover("hide")})).on("show.bs.popover",(function(){setTimeout((()=>{var t=$(".popover-body .form-select");$(t).hasClass("select2-hidden-accessible")||populateSelect(t);var e=$(this).attr("data-lecturerid");if(t.val(e).trigger("change"),"False"==termStatus){var n=$(".popover-body button");t.prop("disabled",!0),n.off("click").on("click",(function(){return toastr.warning("Học kỳ này đã được khoá phân công!"),!1}))}}),0)})),$("#tblAssign").on("click",(function(){hidePopover()})),$(".btn-export").on("click",(function(){var t=rootUrl+"TimeTable/Export?termId="+termId+"&majorId="+majorId;window.open(t,"_blank").focus()}));