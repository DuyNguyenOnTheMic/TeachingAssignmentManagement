var titleText,fileName,detailsFileName,data,ctx=$("#statistics-chart"),chartWrapper=$(".chartjs"),labelColor="#6e6b7b",titleColor="#666666",gridLineColor="rgba(200, 200, 200, 0.2)",dataLoader=$("#data-loader"),isLesson=dataLoader.data("islesson"),type=dataLoader.data("type"),majorId=dataLoader.data("major"),majorAbb=dataLoader.data("majorabb"),majorName=dataLoader.data("majorname"),lecturerType=dataLoader.data("lecturertype"),value=dataLoader.val(),url=rootUrl+"Statistics/";if(type==yearSelect.attr("id")){var yearSplit=value.split(" - "),startYear=yearSplit[0],endYear=yearSplit[1];data={isLesson:isLesson,startYear:startYear,endYear:endYear,majorId:majorId,lecturerType:lecturerType},titleText="Thống kê số giờ giảng năm học "+value+" ngành "+majorName,fileName="ThongKeSoGio_NamHoc_"+startYear+"-"+endYear+"_Nganh_"+majorAbb,detailsFileName="ThongKeChiTietSoGio_NamHoc_"+startYear+"-"+endYear+"_Nganh_"+majorAbb,url+="GetYearData"}else data={isLesson:isLesson,termId:value,majorId:majorId,lecturerType:lecturerType},titleText="Thống kê số giờ giảng HK"+value+" ngành "+majorName,fileName="ThongKeSoGio_HK"+value+"_Nganh_"+majorAbb,detailsFileName="ThongKeChiTietSoGio_HK"+value+"_Nganh_"+majorAbb,url+="GetTermData";$("html").hasClass("dark-layout")&&(titleColor="#d0d2d6",labelColor="#b4b7bd"),chartWrapper.length&&chartWrapper.each((function(){$(this).wrap($('<div style="height:'+this.getAttribute("data-height")+'px"></div>'))})),Chart.defaults.font.family="Montserrat,Helvetica,Arial,serif";var chartOptions={indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scaleShowVerticalLines:!1,responsiveAnimationDuration:500,scales:{x:{stacked:!0,grid:{color:gridLineColor,drawTicks:!1},grace:1,ticks:{color:labelColor}},y:{stacked:!0,grid:{color:gridLineColor},ticks:{autoSkip:!1,color:labelColor}}},plugins:{title:{display:!0,text:titleText,font:{size:25},color:titleColor},subtitle:{display:!0,align:"start",font:{size:15,weight:"bold italic"},color:titleColor},datalabels:{color:labelColor},legend:{labels:{color:labelColor}}}};function hoursSum(t,e){return t.reduce((function(t,a){return t+a[e]}),0)}function populateStatisticsDatatable(t){var e,a=isLessonCheck.is(":checked")?[0,2,3,4,5,6,7,8,9,10,11,12]:[0,2,3,4,5,6,7];e=$("#tblStatistics").DataTable({columns:[{data:"",defaultContent:""},{data:"Key",render:function(t){return"<button type='button' class='btn btn-icon btn-icon rounded-circle btn-success waves-effect waves-float waves-light p-25 viewInfo' title='Xem môn học' data-id='"+t+"'><i class='feather feather-plus'></i></button>"}},{data:"staff_id"},{data:"full_name"},{data:"lecturer_type"},{data:"subject_count"},{data:"class_count"},{data:"sum"},{data:"sumLesson1",defaultContent:""},{data:"sumLesson4",defaultContent:""},{data:"sumLesson7",defaultContent:""},{data:"sumLesson10",defaultContent:""},{data:"sumLesson13",defaultContent:""}],data:t,columnDefs:[{searchable:!1,orderable:!1,width:"1%",targets:[0,1]},{targets:4,render:function(t){var e=t;if(e){var a={CH:{title:"Cơ hữu",class:"badge-light-success"},TG:{title:"Thỉnh giảng",class:"badge-light-warning"}};return'<span class="badge rounded-pill '+a[e].class+' text-capitalized">'+a[e].title+"</span>"}return null}},{className:"text-center",target:[0,1,4,5,6,7,8,9,10,11,12]}],order:[[7,"desc"]],dom:'<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l><"col-sm-12 col-lg-8 ps-xl-75 px-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1"f>B>>>t<"d-flex justify-content-between mx-2 row mb-1"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',displayLength:10,lengthMenu:[[10,25,50,-1],[10,25,50,"tất cả"]],buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle me-2",text:feather.icons.share.toSvg({class:"font-small-4 me-50"})+"Export",buttons:[{extend:"print",className:"dropdown-item",title:fileName,exportOptions:{columns:a}},{extend:"excel",className:"dropdown-item",title:fileName,exportOptions:{columns:a}},{extend:"pdf",className:"dropdown-item",title:fileName,exportOptions:{columns:a}},{extend:"copy",className:"dropdown-item",title:fileName,exportOptions:{columns:a}}],init:function(t,e,a){$(e).removeClass("btn-secondary"),$(e).parent().removeClass("btn-group"),setTimeout((function(){$(e).closest(".dt-buttons").removeClass("btn-group").addClass("d-inline-flex mt-50")}),50)}}],initComplete:function(){isLessonCheck.is(":checked")?setVisibleColumn(!0):setVisibleColumn(!1)},language:{url:rootUrl+"app-assets/language/datatables/vi.json"}}),e.on("draw.dt",(function(){e.column(0,{search:"applied",order:"applied"}).nodes().each((function(t,a){t.innerHTML=a+1,e.cell(t).invalidate("dom")}))})),$("#tblStatistics tbody").on("click","td .viewInfo ",(function(){var t,a=$(this),s=a.closest("tr"),o=e.row(s),l=a.data("id"),n=rootUrl+"Statistics/";if(o.child.isShown())a.removeClass("btn-danger").addClass("btn-success"),a.find("i").removeClass("feather-minus").addClass("feather-plus"),o.child.hide(),s.removeClass("shown");else{if(a.removeClass("btn-success").addClass("btn-danger"),a.find("i").removeClass("feather-plus").addClass("feather-minus"),type==yearSelect.attr("id")){var r=value.split(" - ");n+="GetYearsubjects",t={startYear:r[0],endYear:r[1],majorId:majorId,lecturerId:l}}else n+="GetTermsubjects",t={termId:value,majorId:majorId,lecturerId:l};$.ajax({type:"GET",url:n,data:t,success:function(t){o.child(format(t)).show(),s.addClass("shown")}})}}))}function populateStatisticsDetailsDatatable(t){var e;e=$("#tblStatisticsDetails").DataTable({columns:[{data:"",defaultContent:""},{data:"staff_id"},{data:"full_name"},{data:"class_count"},{data:"classes_taught"},{data:"sum"}],data:t,columnDefs:[{searchable:!1,orderable:!1,width:"1%",targets:0},{className:"text-center",targets:3},{width:"15%",targets:2},{targets:4,render:function(t){return t.join("; ")}},{visible:!1,searchable:!1,targets:5}],order:[[5,"desc"]],dom:'<"d-flex justify-content-between align-items-center header-actions mx-2 row"<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l><"col-sm-12 col-lg-8 ps-xl-75 px-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1"f>B>>>t<"d-flex justify-content-between mx-2 row mb-1"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',displayLength:10,lengthMenu:[[10,25,50,-1],[10,25,50,"tất cả"]],buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle me-2",text:feather.icons.share.toSvg({class:"font-small-4 me-50"})+"Export",buttons:[{extend:"print",className:"dropdown-item",title:detailsFileName,exportOptions:{columns:":visible"}},{extend:"excel",className:"dropdown-item",title:detailsFileName,exportOptions:{columns:":visible"}},{extend:"pdf",className:"dropdown-item",title:detailsFileName,exportOptions:{columns:":visible"}},{extend:"copy",className:"dropdown-item",title:detailsFileName,exportOptions:{columns:":visible"}}],init:function(t,e,a){$(e).removeClass("btn-secondary"),$(e).parent().removeClass("btn-group"),setTimeout((function(){$(e).closest(".dt-buttons").removeClass("btn-group").addClass("d-inline-flex mt-50")}),50)}}],language:{url:rootUrl+"app-assets/language/datatables/vi.json"}}),e.on("draw.dt",(function(){e.column(0,{search:"applied",order:"applied"}).nodes().each((function(t,a){t.innerHTML=a+1,e.cell(t).invalidate("dom")}))}))}function setVisibleColumn(t){for(var e=$("#tblStatistics").DataTable(),a=8;a<=12;a++)e.column(a).visible(t,t);e.columns.adjust().draw(t)}function format(t){for(var e=t.length,a="",s=t.map((function(t){return t.id})),o=t.map((function(t){return t.subject_name})),l=t.map((function(t){return t.subject_credits})),n=t.map((function(t){return t.subject_major})),r=t.map((function(t){return t.subject_hours})),i=t.map((function(t){var e,a=t.theory_count+"LT",s=t.practice_count+"TH";return t.theory_count&&t.practice_count?e=a+" + "+s:t.theory_count?e=a:t.practice_count&&(e=s),e})),d=0;d<e;d++)a+="<tr><td>"+s[d]+"</td><td>"+o[d]+"</td><td>"+n[d]+'</td><td class="text-center">'+l[d]+'</td><td class="text-center">'+i[d]+'</td><td class="text-center">'+r[d]+"</td></tr>";return'<div class="slider"><table class="table table-sm"><thead class="table-light"><tr><th>Mã HP</th><th>Tên HP</th><th>Ngành</th><th class="text-center">Số TC</th><th class="text-center">Số lớp</th><th class="text-center">Số giờ giảng</th></tr></thead><tbody>'+a+"</tbody></table></div>"}$.ajax({type:"GET",url:url,data:data,async:!1,success:function(t){if(t.length){var e,a=t.map((function(t){return"-1"==lecturerType?t.full_name+" ("+t.lecturer_type+")":t.full_name})),s=t.map((function(t){return t.sum}));if("False"==isLesson)e={labels:a,datasets:[{label:"Số giờ giảng",data:s,backgroundColor:"rgba(115, 103, 240, 0.8)",borderColor:"transparent",borderWidth:1,borderRadius:3,datalabels:{anchor:"end",align:"start",offset:-30}}]},chartOptions.plugins.legend.display=!1,chartOptions.plugins.subtitle.padding={bottom:10};else e={labels:a,datasets:[{label:"Ca 1",data:t.map((function(t){return t.sumLesson1})),backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1,borderRadius:3},{label:"Ca 2",data:t.map((function(t){return t.sumLesson4})),backgroundColor:"rgba(255, 99, 132, 0.5)",borderColor:"rgba(255, 99, 132, 1)",borderWidth:1,borderRadius:3},{label:"Ca 3",data:t.map((function(t){return t.sumLesson7})),backgroundColor:"rgba(255, 205, 86, 0.5)",borderColor:"rgba(255, 205, 86, 1)",borderWidth:1,borderRadius:3},{label:"Ca 4",data:t.map((function(t){return t.sumLesson10})),backgroundColor:"rgba(75, 192, 192, 0.5)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1,borderRadius:3},{label:"Ca 5",data:t.map((function(t){return t.sumLesson13})),backgroundColor:"rgba(153, 102, 255, 0.5)",borderColor:"rgba(153, 102, 255, 1)",borderWidth:1,borderRadius:3}]},chartOptions.plugins.datalabels={color:labelColor,font:{size:"9"}};chartOptions.plugins.subtitle.text="Số giảng viên: "+t.length+" / Tổng số giờ: "+hoursSum(t,"sum");var o=new Chart(ctx,{type:"bar",data:e,options:chartOptions,plugins:[ChartDataLabels]});o.options.plugins.legend.onClick=function(t,e,a){const s=e.datasetIndex,l=a.chart;l.isDatasetVisible(s)?(l.hide(s),e.hidden=!0):(l.show(s),e.hidden=!1);for(var n=0,r=[],i=0;i<5;i++)if(l.isDatasetVisible(i)){const t=o.data.datasets[i].data;n+=t.reduce(((t,e)=>t+e),0),r.push(t)}var d=0;r.length&&(d=r.reduce(((t,e)=>t.map(((t,a)=>e[a]+t)))).filter((t=>t>0)).length),chartOptions.plugins.subtitle.text="Số giảng viên: "+d+" / Tổng số giờ: "+n,o.update()},$(".nav-link-style").on("click",(function(){var t,e;$("html").hasClass("dark-layout")?(t="#d0d2d6",e="#b4b7bd"):(t="#666666",e="#6e6b7b"),o.options.plugins.subtitle.color=t,o.options.plugins.title.color=t,o.options.plugins.datalabels.color=t,o.options.plugins.legend.labels.color=e,o.options.scales.x.ticks.color=e,o.options.scales.y.ticks.color=e,o.update()})),populateStatisticsDatatable(t),populateStatisticsDetailsDatatable(t)}else showNoData(statisticsDiv,'<i class="feather feather-help-circle"></i>')}}),$('a[data-bs-toggle="tab"]').on("shown.bs.tab",(function(t){$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust()}));